---
title: "social_rent_rdd_markdown"
author: "Michael Marshall"
date: "24/03/2022"
output: github_document
---

# Background: Evidence from a natural experiment on the effects of grant funding on social rented housing delivery

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, include = FALSE}
# loading packages and data ---------------------------------------

pacman::p_load(tidyverse, readxl, lubridate, jtools, lme4, lmerTest,
               stargazer)

rm(list = ls())

# affordable housing starts
df <- read_excel("affordable housing starts data.xlsx")

# high pressure affordability areas
hp <- read_csv("high_pressure_areas.csv")

# making dataset of social rent proportions per LA per year --------

#function to summarise and join vars
left_join_summ <- function(data, data2, tenure, funding,
                           str_fund){
  
  str_ten <- tenure %>% 
    str_to_lower() %>% 
    str_replace_all(" ","_") %>% 
    str_c("_units")
  
  if(missing(funding) & missing(str_fund)){
    
    left_join(
      data, 
      data2 %>%
        group_by(`LA code`, Year, Tenure) %>%
        summarise({{str_ten}} := sum(Units), 
                  .groups = "drop") %>%
        filter(Tenure == tenure) %>% 
        select(-Tenure),
      by = c("LA code", "Year")
    )
    
  } else {
    
    str_var <- str_c(str_fund, str_ten)
    
    left_join(
      data, 
      data2 %>%
        group_by(`LA code`, Year, LT1000, Tenure) %>%
        summarise({{str_var}} := sum(Units), 
                  .groups = "drop") %>%
        filter(Tenure == tenure & LT1000 == funding) %>% 
        select(-Tenure, -LT1000),
      by = c("LA code", "Year")
    )
    
  }
  
  
  
}

sr_df <- df %>% 
  filter(`Region name` != "London") %>% 
  group_by(`LA code`, Year) %>% 
  summarise(units = sum(Units),
            .groups = "drop") %>% 
  left_join_summ(data2 = df, tenure = "Social Rent") %>% 
  left_join_summ(data2 = df, tenure = "Affordable Rent") %>% 
  left_join_summ(data2 = df,
                 tenure = "Social Rent",
                 funding = "Private Registered Provider HE/GLA funded",
                 str_fund = "prp_he_") %>% 
  left_join_summ(data2 = df,
                 tenure = "Social Rent",
                 funding = "Private Registered Provider other funding",
                 str_fund = "prp_other_") %>% 
  left_join_summ(data2 = df,
                 tenure = "Social Rent",
                 funding = "Local Authority HE/GLA funded",
                 str_fund = "la_he_") %>% 
  left_join_summ(data2 = df,
                 tenure = "Social Rent",
                 funding = "Local Authority other funding",
                 str_fund = "la_other_")

# turning NAs into zeros --------------------------------------

# variables with number of units
units_vars <- sr_df %>% 
  select(ends_with("units")) %>% 
  names()

# function to turn to 0
make_zero <- function(x){
  out <- ifelse(is.na(x), 0, x) 
  return(out)
}

# test df
test <- sr_df[units_vars] %>% 
  map_df(make_zero)

# check the test works
mean(test[units_vars] == sr_df[units_vars], na.rm = T)

sr_df[units_vars] <- sr_df[units_vars] %>% 
  map_df(make_zero)

# post change test
mean(test[units_vars] == sr_df[units_vars])

# removing test
rm(test)

# calculating proportions ------------------------------------------

# calculating the number of SR units as a proportion of total units
# and adding binary variable for high pressure from RSH list

sr_df <- sr_df %>%
  mutate(prop_sr = social_rent_units / units,
         prop_ar = affordable_rent_units / units,
         prop_sr_he = prp_he_social_rent_units / units,
         prop_sr_other = prp_other_social_rent_units / units,
         prop_sr_la_he = la_he_social_rent_units / units,
         prop_sr_la_other = la_other_social_rent_units / units) %>% 
  mutate(rsh_treat = ifelse(`LA code` %in% hp$`LA code`,
                1, 0),
         Year = as.factor(Year))

count(sr_df, rsh_treat)

sr_df %>% 
  map_int(~sum(is.na(.)))

# merging with rent data -----------------------------------------

load("rent_gap_full.Rdata")

sr_df <- sr_df %>% 
  left_join(rent_gap_full,
            by = c("LA code", "Year"))

# plot to check effectiveness of rent gap calculation
# filtering to 2016/17 as this is the year for RSH treatment calc
sr_df %>% 
  filter(Year == "2016-17") %>% 
  ggplot(aes(x = afford_gap_mean, fill = as.factor(rsh_treat))) +
  geom_histogram(bins = 150, alpha = .7, colour = "black") +
  scale_fill_manual(values = c("darkgrey","white")) +
  labs(fill = "High pressure") +
  geom_vline(xintercept = 50, linetype = "dashed", size = 1,
             colour = "red") +
  theme_bw()

# median maps onto treatment better
sr_df %>% 
  filter(Year == "2016-17") %>%
  ggplot(aes(x = afford_gap_median, fill = as.factor(rsh_treat))) +
  geom_histogram(bins = 150, alpha = .7, colour = "black") +
  scale_fill_manual(values = c("darkgrey","white")) +
  labs(fill = "High pressure") +
  geom_vline(xintercept = 50, linetype = "dashed", size = 1,
             colour = "red") +
  theme_bw()

# regression discontinuity design ------------------------------

# some treatment errors around the point of discontinuity
# Cheshire East, Tamworth, Sheffield, Plymouth, Stroud, Bury
sr_df %>%
  filter(Year == "2016-17") %>% 
  mutate(
    treatment = ifelse(afford_gap_median >= 50, 1, 0),
    errors = ifelse(treatment == 0 & rsh_treat == 1 |
                      treatment == 1 & rsh_treat == 0, 1, 0)
  ) %>%
  arrange(desc(errors), desc(treatment)) %>% 
  select(errors, treatment, afford_gap_median, la_name) %>% 
  head(10)

# number of dwellings data ---------------------------

lt_125 <- read_excel(
  "LT_125.xlsx",
  sheet = "Table_125_(unrounded)",
  range = "B6:Y426"
)

# pivoting, filtering to relevant years, and relevelling year ----------

lt_125 <- lt_125 %>% 
  pivot_longer(cols = `2001`:`2020`, 
               values_to = "total_dwellings",
               names_to = "Year") %>% 
  filter(Year %in% c("2016","2017","2018","2019","2020")) %>% 
  mutate(
    Year = fct_recode(
      as.factor(Year),
      "2015-16" = "2016",
      "2016-17" = "2017",
      "2017-18" = "2018",
      "2018-19" = "2019",
      "2019-20" = "2020"
    )
  ) %>% 
  select(-name_1, -name_2, -Region)

# merging total dwellings to modelling dataset
sr_df <- sr_df %>% 
  left_join(lt_125, by = c("LA code", "Year"))

# rdd on rate per 1000 dwellings -------------------------------

sr_df <- sr_df %>%
  mutate(dwellings_1000 = total_dwellings / 1000,
         total_units_per_1000 = units / dwellings_1000,
         per_1000_sr = social_rent_units / dwellings_1000,
         per_1000_ar = affordable_rent_units / dwellings_1000,
         per_1000_sr_he = prp_he_social_rent_units / dwellings_1000,
         per_1000_sr_other = prp_other_social_rent_units / dwellings_1000,
         per_1000_sr_la_he = la_he_social_rent_units / dwellings_1000,
         per_1000_sr_la_other = la_other_social_rent_units / dwellings_1000,
         treatment = ifelse(afford_gap_median >= 50, 1, 0))

years_list <- sr_df %>% 
  split(.$Year)

# years_list %>% map(head, 10)

# !!insert imai method script here!! -------------------------------
```

## Data and methodology  

In October 2017, the government announced it would provide additional funding for the supply of new social rented housing via Homes England. But it would only provide additional funding in areas of ['high affordability pressure']("https://www.gov.uk/government/publications/areas-of-high-affordability-pressure/list-areas-of-high-affordability-pressure"), defined by the government as local authorities where the gap between average social rents and average private rents is 50 GBP or more.

The analysis below views this policy as a natural experiment, whereby the treatment is whether social rent is grant funded in a local authority or not, and the outcome is the rate of social rent delivery within a local authority in a given year.

The data for the analysis is:  

* [DLUHC: Live table 1011S: Additional Affordable Housing Supply; detailed breakdown by Local Authority, Starts on site](https://www.gov.uk/government/statistical-data-sets/live-tables-on-affordable-housing-supply)  
* [DLUHC: Live table 125: dwelling stock estimates by local authority district](https://www.gov.uk/government/statistical-data-sets/live-tables-on-dwelling-stock-including-vacants)  
* [RSH: Statistical data return (SDR) for private registered providers, years 2015/16 to 2019/20](https://www.gov.uk/government/collections/statistical-data-return-statistical-releases)  
* [VOA: Private rental market statistics, years 2015/16 to 2017/18](https://www.gov.uk/government/collections/private-rental-market-statistics)  
* [ONS: Private rental market summary statistics in England, years 2018/19 to 2019/20](https://www.ons.gov.uk/peoplepopulationandcommunity/housing/datasets/privaterentalmarketsummarystatisticsinengland)  

Within the dataset, each observation is a local authority within a given year. London local authorities are excluded as they are funded via the Greater London Authority (GLA), not Homes England.  The continuous variable that defines the treatment is the gap between average social rents and private rents in GBP, and this is calculated using the SDR, VOA and ONS data (as per the Homes England explanation of their methodology).  The treatment is having an affordability gap above 50 GBP. The outcome variable is the number of social rent starts on site within a given local authority. However, this outcome is calculated in three different ways, yielding three dependent variables:

1. Social rent starts as a proportion of all affordable homes starts within the local authority  
2. Social rent starts as a rate per 1,000 existing dwellings in the local authority  
3. Social rent starts by housing associations (also known as Private Registered Providers, hereby PRPs), as a rate per 1,000 existing dwellings in the local authority  

The research question is *"what effect did the increase in social rent grant funding have on the rate of social rent delivery in local authorities, especially social rented housing delivered by PRPs?"*  However, two other dependent variables are modelled in the analysis as comparators.  The comparator dependent variables, and their purposes as comparators, are:  

* Total affordable homes starts as a rate per 1,000 dwellings in the local authority -- used to understand whether there is a multiplier effect from social rent grant funding i.e. is grant being used to deliver more homes overall, or to deliver the same number of homes but with a higher proportion of social rent?  
* Total affordable rent starts as a rate per 1,000 dwellings in the local authority -- used as a placebo to provide increased confidence that any treatment effect identified in the analysis is genuine. In other words, we should expect to see no effect on affordable rent starts from increased social rent funding, and so if we find an effect for social renting but not affordable renting, this increases our confidence the social rent treatment effect is genuine and not a result of chance.  

The analysis uses a regression discontinuity design (RDD) to model the treatment effect of grant funding. RDD offers a methodology for causal inference in natural experiments where a disjuncture in a continuous independent variable defines the binary treatment variable. In other words, the affordability gap between social and private rents features a *discontinuity* at the 50 GBP point, around which the treatment status switches from control (i.e. no grant) to treatment (i.e. grant funding). A binary dummy variable for the presence of treatment is included in a  regression analysis, controlling for the continuous affordability gap variable (centred at the point of discontinuity). As such the model intercept is the average social rented delivery in the control group, and the coefficient of the treatment dummy variable is the *average-treatment-effect-on-the-treated (ATT)*.  

Due to the non-randomisation of the treatment status in an RDD, the ATT estimate only applies to observations around the point of discontinuity (i.e. those close to the 50 GBP threshold). Therefore, it is common to conduct a sensitvity analysis whereby the RDD is repeated on a subsample of observations close to the point of discontinuity.  This analysis also assumes a simple linear regression model for the functional form of the running varibale (i.e. affordability gap). Different functional forms could obviously be modelled. But the visualisations of the ATTs (i.e. Figures 7 to 11) suggest the relationship between affordability gap and social rent output, independent of the funding policy treatment, is orthogonal. And therefore the effect of affordability gap is unlikely to differ substantially in different specifications of the model. 

Finally, although the funding was announced in October 2017, there is likely to be a lag before any treatment effect is identifiable. This is demonstrated by the exploratory visualisations below, in particular Figures 4 and 5. This is attributable to the numerous administrative and logistical steps involved in going from a grant application to actually starting on site, a process which can take a number of years. Prior to conducting RDD, a set of longitudinal models were produced for each dependent variable. The longitudinal models use a multilevel modelling framework, including random intercepts for each local authority. Three longitudinal models were produced per dependent variable, varying in terms of their fixed effects, which are as follows:  

1. an additive model with independent fixed effects for the treatment variable and a categorical variable for year  
2. interaction model with treatment status interacted with each year category in the year variable  
3. interaction model with treatment status interacting with *only* the 2019/20 category in year (all other years included as independent fixed effects)  

The longitudinal models revealed that the model fit -- as measured by AIC -- was optimised in model 3, whereby treatment interacts with 2019/20 only. The results of these models are shown below with respect to the *social rent starts as a proportion of all affordable homes starts* dependent variable, but this pattern was replicated across all three dependent variables.  The findings of the longitudinal model suggest a treatment effect from grant funding is plausible, but may not have appeared until 2019/20. As such, the RDD compares the ATT between 2015/16 (pre-treatment) and 2019/20 (post-treatment) for each dependent variable.  Prior to modelling, though, a number of exploratory visualisations are presented.  

# Exploratory visualisations

Figure 1 shows all affordable home starts by tenure and year, including London local authorities. There is a clear increase in social rent as a proportion of all affordable homes post-2015-16. And when London Affordable Rent is included (which has grant and rent levels comparable to social rent), this growth is even higher. There is the potential for this trend to be an administrative artifice, though. As there is also an increased number of 'unknown' tenure construction starts over time, and so these proportions could shift as the eventual tenure is determined upon completion. Moreover, the proportion of social rented homes does not compare local authority supply according to a common baseline, as the proportion will fluctuate according to the size of the denominator (i.e. the overall rate of affordable housing delivery in a local authority), which is one of the motivating factors for including a dependent variable with social renting as a rate per 1,000 existing dwellings. Nevertheless, Figure 1 still provides suggestive evidence that social rent supply grew over the period in question.   

```{r}
df %>% 
  group_by(Year, Tenure) %>% 
  summarise(units = sum(Units),
            .groups = "drop") %>% 
  mutate(
    Tenure = fct_rev(fct_relevel(Tenure,
                                 "Social Rent",
                                 "London Affordable Rent",
                                 "Affordable Rent",
                                 "Shared Ownership",
                                 "Affordable Home Ownership"))
  ) %>% 
  ggplot(aes(x = Year, y = units, fill = Tenure)) +
  geom_col(position = "fill", colour = "white") +
  theme_bw() +
  scale_fill_viridis_d() +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Proportion of affordable homes starts",
       caption = "Figure 1: Affordable homes starts by tenure and financial year. All England local authorities.\nSource: DLUHC: Live table 1011S.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(size = 12,
                                    hjust = 0))
```

Figure 2 replicates Figure 1, but excludes London local authorities. And shows a similar trend in terms of the proportion of social rented starts.  


```{r, warning = FALSE}
df %>% 
  filter(`Region name` != "London") %>% 
  group_by(Year, Tenure) %>% 
  summarise(units = sum(Units),
            .groups = "drop") %>% 
  mutate(
    Tenure = fct_rev(fct_relevel(Tenure,
                                 "Social Rent",
                                 "London Affordable Rent",
                                 "Affordable Rent",
                                 "Shared Ownership",
                                 "Affordable Home Ownership"))
  ) %>% 
  ggplot(aes(x = Year, y = units, fill = Tenure)) +
  geom_col(position = "fill", colour = "white") +
  theme_bw() +
  scale_fill_viridis_d() +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Proportion of affordable homes starts",
       caption = "Figure 2: Affordable homes starts by tenure and financial year. Excluding London.\nSource: DLUHC: Live table 1011S.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(size = 12,
                                    hjust = 0))
```

Figure 3 shows social rent starts as a proportion of all affordable homes starts, and disaggregates by scheme type. Unsurprisingly, the largest growth in social rented proportion has been in schemes funded by Homes England or the GLA. The proportion of social renting is broadly stable in 'other funding' schemes (i.e. non-grant funded).  Figure 3 shows all local authorities, including London.  


```{r, warning = FALSE}
df %>% 
  filter(!LT1000 %in% c("Non-Registered Provider HE funded",
                        "Other",
                        "Right to Buy recycled receipts",
                        "s106 nil grant",
                        "s106 part grant")) %>% 
  group_by(Year, Tenure, LT1000) %>%
  summarise(units = sum(Units),
            .groups = "drop") %>% 
  mutate(
    Tenure = fct_rev(fct_relevel(Tenure,
                                 "Social Rent",
                                 "London Affordable Rent",
                                 "Affordable Rent",
                                 "Shared Ownership",
                                 "Affordable Home Ownership"))
  ) %>% 
  ggplot(aes(x = Year, y = units, fill = Tenure)) +
  geom_col(position = "fill", colour = "white") +
  facet_wrap(~str_wrap(LT1000, 20)) +
  theme_bw() +
  scale_fill_viridis_d(option = "C") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Proportion of affordable homes starts",
       caption = "Figure 3: Affordable homes starts by tenure, financial year and scheme type.\nAll England local authorities. Source: DLUHC: Live table 1011S.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(size = 12,
                                    hjust = 0),
        axis.text.x = element_text(angle = 90,
                                   vjust = 0.5))
```


Figure 4 shows the rate of social renting starts per 1,000 existing dwellings in a local authority. It disaggregates the rate by treatment status, showing whether a local authority is *high affordability pressure* or not (1 = high pressure). Figure 4 shows the lagged effect of the funding change.   


```{r}
sr_df %>% 
  filter(Year != "2020-21" & !is.na(treatment)) %>%
  group_by(Year, treatment) %>% 
  summarise(per_1000_sr = mean(per_1000_sr, na.rm = T),
            .groups = "drop") %>% 
  ggplot(aes(x = Year, y = per_1000_sr, 
             fill = as.factor(treatment))) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d() +
  labs(y = "Mean social rent starts\nper 1000 existing dwellings",
       caption = "Figure 4: Rate of new social rent starts per 1000 existing dwellings in local authority.\nHigh pressure is rent gap > 50 GBP. Excluding London.",
       fill = "High pressure") +
  theme_bw() +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0,
                                    size = 12),
        legend.position = "bottom")
```


Figure 5 replicates Figure 4, but separates the rate of new social rent delivery by whether it is delivered by either a PRP or a local authority (LA).  The trend is broadly similar until the sharp increase in PRP delivery in high pressure local authorities in 2019/20.  


```{r}
sr_df %>% 
  filter(Year != "2020-21" & !is.na(treatment)) %>% 
  mutate(`PRP delivery` = per_1000_sr_he + per_1000_sr_other,
         `LA delivery` = per_1000_sr_la_he + per_1000_sr_la_other) %>% 
  select(`LA code`, Year, treatment, `PRP delivery`, `LA delivery`) %>% 
  pivot_longer(`PRP delivery`:`LA delivery`,
               names_to = "prp_la",
               values_to = "per_1000_sr") %>%
  group_by(Year, treatment, prp_la) %>% 
  summarise(per_1000_sr = mean(per_1000_sr, na.rm = T),
            .groups = "drop") %>% 
  ggplot(aes(x = Year, y = per_1000_sr, 
             fill = as.factor(treatment))) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d() +
  facet_wrap(~prp_la) +
  labs(y = "Mean social rent starts\nper 1000 existing dwellings",
       caption = "Figure 5: Rate of new social rent starts per 1000 existing dwellings in local authority,\ndisaggregated by delivery source. High pressure is rent gap > 50 GBP. Excluding London.",
       fill = "High pressure") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust = 1),
        plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0,
                                    size = 12),
        legend.position = "bottom")
```

Figure 6 shows the rate of delivery for affordable rent (i.e. the placebo).  There is little overall change in affordable rent delivery over time, and little variation according to treatment status.  


```{r}
sr_df %>% 
  filter(Year != "2020-21" & !is.na(treatment)) %>% 
  group_by(Year, treatment) %>% 
  summarise(per_1000_ar = mean(per_1000_ar, na.rm = T),
            .groups = "drop") %>% 
  ggplot(aes(x = Year, y = per_1000_ar, 
             fill = as.factor(treatment))) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d() +
  labs(y = "Mean affordable rent starts\nper 1000 existing dwellings",
       caption = "Figure 6: Rate of new affordable rent starts per 1000 existing dwellings in local authority.\nHigh pressure is rent gap > 50 GBP. Excluding London.",
       fill = "High pressure") +
  theme_bw() +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0,
                                    size = 12),
        legend.position = "bottom")
```

# Modelling

## Longitudinal modelling

The tables below show the results of the longitudinal models where the dependent variable is social rented starts as a proportion of total affordable homes starts.  The first model is the additive model with no interactions. It shows no effect of the treatment, but a general increase in the proportion of social rented housing each year relative to the 2015/16 baseline.  

```{r, include = FALSE}
sr_df <- sr_df %>% 
  mutate(`1920` = ifelse(Year == "2019-20", 1, 0),
         `1819` = ifelse(Year == "2018-19", 1, 0),
         `1718` = ifelse(Year == "2017-18", 1, 0),
         `1617` = ifelse(Year == "2016-17", 1, 0))
```


```{r}
# AIC = -989.01
sr_df %>% 
  lmer(prop_sr ~ treatment + Year + I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


The second longitudinal model includes an interaction between treatment and each category of the year variable. This analysis adopts the recommendations of [Benjamin et al. (2017)](https://www.nature.com/articles/s41562-017-0189-z) regarding statistical significance thresholds when identifying novel effects. To reduce the likelihood of false positives, they recommend a threshold of 0.005 for statistical significance, and that the traditional threshold of 0.05 should be rebranded as 'suggestive' of an association.  According to these criteria, a statistically significant effect is found for the interaction between treatment and 2019/20 but none of the other years. The interaction between treatment and 2016/17 is suggestive of an effect, but the AIC statistic is worse (suggesting potential overfitting). Plus, the interaction between 2016/17 and treatment was non-significant for the other two dependent variables (i.e. social rent as a rate of all dwellings, social rent by PRPs as a rate of all dwellings). So it was decided to focus on the interaction between treatment and 2019/20.  


```{r}
# AIC = -989.01
sr_df %>% 
  lmer(prop_sr ~ (treatment * Year) + I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```

The table below shows the longitudinal analysis results for the model with an interaction between 2019/20 and treatment only. This interaction effect is statistically significant, and the AIC statistic of this model is the best of each models.  These patterns of statistical significance and model fit were replicated across each three dependent variables. In fact, the reduction in AIC from the additive model to the 2019/20 interaction only model was greatest for the *rate of social rent by PRPs per 1,000 existing dwellings* dependent variable.   


```{r}
# AIC = -995.30
sr_df %>% 
  lmer(prop_sr ~ (treatment * `1920`) + `1819` + `1718` + `1617` + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```

# RDD

## Social rent starts as a proportion of affordable homes starts

The table below shows the model results for the RDD on social rent starts as a proportion of affordable homes starts in 2015/16 and 2019/20. A statistically significant treatment effect is found in 2019/20, with an effect size equivalent to a 10% increase in social rent delivery. Sensitivity analysis was conducted by reducing the sample to local authorities with an affordability gap between 20 - 80 GBP. A treatment effect of 7% was found in this subsample, but it was not statistically significant. However, reducing the sample size is known to inflate standard errors, and this should be borne in mind when interpreting the results of the sensitivity analysis.  In neither case was a treatment effect found in 2015/16, giving support to the notion that the policy change had an effect on social rented supply.  

Figure 7 visualises this treatment effect, showing the proportion of affordable homes starts that were social rent by year. The top two panels show the relationship between affordability gap and social rent delivery in 2015/16; the estimated OLS regression line is split at the point of discontinuity, and the affordability gap is centred at this same point. The bottom two panels show the same for 2019/20. The gap between intercepts around the point of discontinuity can therefore be interpreted as the ATT.  In 2015/16 there is very little difference between the model intercepts in control and treatment local authorities. There is a clear increase in social rent proportion in treatment local authorities in 2019/20, as represented by the gap between the intercepts in the bottom two panels in Figure 7.  

```{r, results = 'asis'}
sr_mods <- list()

sr_mods[c("2015-16", "2019-20")] <- years_list[c(1,5)] %>% 
  map(~lm(prop_sr ~ treatment + I(afford_gap_median - 50),
          data = .))

sr_mods[c("2015-16 sensitivity","2019-20 sensitivity")] <-
  years_list[c(1,5)] %>% 
  map(filter, afford_gap_median > 20 & afford_gap_median < 80) %>% 
  map(~lm(prop_sr ~ treatment + I(afford_gap_median - 50),
          data = .))

stargazer(sr_mods[[1]], sr_mods[[2]], sr_mods[[3]], sr_mods[[4]],
          type = "html",
          style = "ajps",
          dep.var.labels = 
            "Social rent as proportion of affordable homes starts",
          title = "Social Rent Proportion RDD results",
          align = T,
          omit.stat=c("LL","ser","f"),
          column.labels = c("2015/16",
                            "2019/20",
                            "2015/16: subsample",
                            "2019/20: subsample"),
          star.cutoffs = c(0.05, 0.005, 0.001),
          report = c("vcs*")
)
          
```


```{r, message = FALSE, warning = FALSE}
bind_rows(
  years_list[[1]],
  years_list[[5]]
) %>% 
  mutate(treatment = ifelse(treatment == 1, 
                            "High pressure",
                            "Not high pressure"),
         treatment = fct_relevel(treatment, "Not high pressure")) %>% 
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = I(afford_gap_median - 50),
             y = prop_sr)) +
  geom_point(alpha = 1/2) +
  geom_smooth(method = "lm") +
  coord_cartesian(ylim = c(0,0.4)) +
  facet_grid(rows = vars(Year),
             cols = vars(treatment),
             scales = "free_x") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Affordability gap (GBP, centred around discontinuity)", 
       y = "Social rent as a proportion of affordable homes starts",
       caption = "Figure 7: Treatment effect for social rent as a proportion of affordable homes starts.\n2015-16 compared with 2019/20. Excluding London. Y-axis is truncated for easier comparisons.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))
```


## Social rent starts per 1,000 dwellings

```{r, include = FALSE}
# AIC 1868.88
sr_df %>% 
  lmer(per_1000_sr ~ treatment + Year + I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


```{r, include = FALSE}
# AIC 1864.32
sr_df %>% 
  lmer(per_1000_sr ~ (treatment * `1920`) + `1819` + `1718` + `1617` + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


The table below shows the RDD results for the rate of social rent starts per 1,000 existing dwellings. The ATT is estimated as 0.27 new social rent starts per 1,000 dwellings in 2019/20, and this effect is statistically significant. In the subsample sensitivity analysis, the ATT is estimated at 0.26, and the p-value is below 0.05, which is interpreted as suggestive of an effect.  Figure 8 visualises the ATT, again showing very little evidence of a treatment effect in 2015/16, but a clear gap between the intercepts of control and treatment groups in 2019/20.   


```{r, results = 'asis'}
sr_rate_mods <- list()

sr_rate_mods[c("2015-16", "2019-20")] <- years_list[c(1,5)] %>% 
  map(~lm(per_1000_sr ~ treatment + I(afford_gap_median - 50),
          data = .))

sr_rate_mods[c("2015-16 sensitivity","2019-20 sensitivity")] <-
  years_list[c(1,5)] %>% 
  map(filter, afford_gap_median > 20 & afford_gap_median < 80) %>% 
  map(~lm(per_1000_sr ~ treatment + I(afford_gap_median - 50),
          data = .))

stargazer(sr_rate_mods[[1]], sr_rate_mods[[2]],
          sr_rate_mods[[3]], sr_rate_mods[[4]],
          type = "html",
          style = "ajps",
          dep.var.labels = "Social rent per 1000 dwellings",
          title = "Social Rent Rate RDD results",
          align = T,
          omit.stat=c("LL","ser","f"),
          column.labels = c("2015/16",
                            "2019/20",
                            "2015/16: subsample",
                            "2019/20: subsample"),
          star.cutoffs = c(0.05, 0.005, 0.001),
          report = c("vcs*")
)
          
```


```{r, message = FALSE, warning = FALSE}
bind_rows(
  years_list[[1]],
  years_list[[5]]
) %>% 
  mutate(treatment = ifelse(treatment == 1, 
                            "High pressure",
                            "Not high pressure"),
         treatment = fct_relevel(treatment, "Not high pressure")) %>% 
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = I(afford_gap_median - 50),
             y = per_1000_sr)) +
  geom_point(alpha = 1/2) +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(Year),
             cols = vars(treatment),
             scales = "free_x") +
  theme_bw() +
  coord_cartesian(ylim = c(0,1)) +
  labs(x = "Affordability gap (GBP, centred around discontinuity)", 
       y = "Social rent starts per 1000 existing dwellings",
       caption = "Figure 8: Treatment effect for rate of social rent starts per 1000 existing dwellings.\n2015-16 compared with 2019/20. Excluding London. Y-axis is truncated for easier comparisons") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))
```

## Social rent starts by PRPs per 1,000 dwellings

```{r, include = FALSE}
# AIC -1567.56
sr_df %>% 
  mutate(per_1000_prp = per_1000_sr_he + per_1000_sr_other) %>% 
  lmer(per_1000_prp ~ treatment + Year + I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ

# AIC -1602.19
sr_df %>% 
  mutate(per_1000_prp = per_1000_sr_he + per_1000_sr_other) %>%
  lmer(per_1000_prp ~ (treatment * `1920`) + `1819` + `1718` + `1617` + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


The table below shows the RDD results for the rate of social rent starts by PRPs per 1,000 existing dwellings. The ATT is estimated as 0.12 new social rent starts by PRPs per 1,000 dwellings in 2019/20, and this effect is statistically significant. In the subsample sensitivity analysis, the ATT is estimated at 0.10, and the p-value is below 0.05, which is interpreted as suggestive of an effect.  Figure 9 visualises the ATT. 


```{r, results = 'asis'}
sr_prp_mods <- list()

sr_prp_mods[c("2015-16", "2019-20")] <- years_list[c(1,5)] %>% 
  map(mutate, per_1000_prp = per_1000_sr_he + per_1000_sr_other) %>% 
  map(~lm(per_1000_prp ~ treatment + I(afford_gap_median - 50),
          data = .))

sr_prp_mods[c("2015-16 sensitivity","2019-20 sensitivity")] <-
  years_list[c(1,5)] %>% 
  map(mutate, per_1000_prp = per_1000_sr_he + per_1000_sr_other) %>%
  map(filter, afford_gap_median > 20 & afford_gap_median < 80) %>% 
  map(~lm(per_1000_prp ~ treatment + I(afford_gap_median - 50),
          data = .))

stargazer(sr_prp_mods[[1]], sr_prp_mods[[2]],
          sr_prp_mods[[3]], sr_prp_mods[[4]],
          type = "html",
          style = "ajps",
          dep.var.labels = "Social rent by PRPs per 1000 dwellings",
          title = "Social Rent by PRPs Rate RDD results",
          align = T,
          omit.stat=c("LL","ser","f"),
          column.labels = c("2015/16",
                            "2019/20",
                            "2015/16: subsample",
                            "2019/20: subsample"),
          star.cutoffs = c(0.05, 0.005, 0.001),
          report = c("vcs*")
)
          
```



```{r, message = FALSE, warning = FALSE}
bind_rows(
  years_list[[1]],
  years_list[[5]]
) %>% 
  mutate(treatment = ifelse(treatment == 1, 
                            "High pressure",
                            "Not high pressure"),
         treatment = fct_relevel(treatment, "Not high pressure"),
         per_1000_prp = per_1000_sr_he + per_1000_sr_other) %>% 
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = I(afford_gap_median - 50),
             y = per_1000_prp)) +
  geom_point(alpha = 1/2) +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(Year),
             cols = vars(treatment),
             scales = "free_x") +
  theme_bw() +
  labs(x = "Affordability gap (GBP, centred around discontinuity)", 
       y = "Social rent starts per 1000 existing dwellings",
       caption = "Figure 9: Treatment effect for rate of social rent starts delivered by PRPs per 1000 existing dwellings.\n2015-16 compared with 2019/20. Excluding London.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))
```


## Total affordable homes starts per 1,000 dwellings

The table below shows the RDD results for rate of total affordable homes starts per 1,000 existing dwellings. It finds no treatment effect on total affordable homes starts.  This suggests there is no multiplier effect from the policy change i.e. the grant funding is used by PRPs to increase the number of social rented homes, not the total number of homes.  Figure 10 visualises the lack of ATT, as there is little gap between the intercepts of control and treatment groups in both 2015/16 and 2019/20.  


```{r, include = FALSE}
# AIC 5311.08
sr_df %>% 
  lmer(total_units_per_1000 ~ treatment + Year + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ

# AIC 5312.63
sr_df %>% 
  lmer(total_units_per_1000 ~ (treatment * `1920`) + 
         `1819` + `1718` + `1617` + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


```{r, results = 'asis'}
total_mods <- list()

total_mods[c("2015-16", "2019-20")] <- years_list[c(1,5)] %>% 
  map(~lm(total_units_per_1000 ~ treatment + I(afford_gap_median - 50),
          data = .))

total_mods[c("2015-16 sensitivity","2019-20 sensitivity")] <-
  years_list[c(1,5)] %>% 
  map(filter, afford_gap_median > 20 & afford_gap_median < 80) %>% 
  map(~lm(total_units_per_1000 ~ treatment + I(afford_gap_median - 50),
          data = .))

stargazer(total_mods[[1]], total_mods[[2]],
          total_mods[[3]], total_mods[[4]],
          type = "html",
          style = "ajps",
          dep.var.labels = 
            "Total affordable homes starts per 1000 dwellings",
          title = "Total affordable homes RDD results",
          align = T,
          omit.stat=c("LL","ser","f"),
          column.labels = c("2015/16",
                            "2019/20",
                            "2015/16: subsample",
                            "2019/20: subsample"),
          star.cutoffs = c(0.05, 0.005, 0.001),
          report = c("vcs*")
)
          
```


```{r, message = FALSE, warning = FALSE}
bind_rows(
  years_list[[1]],
  years_list[[5]]
) %>% 
  mutate(treatment = ifelse(treatment == 1, 
                            "High pressure",
                            "Not high pressure"),
         treatment = fct_relevel(treatment, "Not high pressure")) %>% 
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = I(afford_gap_median - 50),
             y = total_units_per_1000)) +
  geom_point(alpha = 1/2) +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(Year),
             cols = vars(treatment),
             scales = "free_x") +
  theme_bw() +
  labs(x = "Affordability gap (GBP, centred around discontinuity)", 
       y = "Total affordable homes starts per 1000 existing dwellings",
       caption = "Figure 10: Treatment effect for rate of affordable homes starts per 1000 existing dwellings.\n2015-16 compared with 2019/20. Excluding London.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))
```

## Placebo - rate of affordable rent starts per 1,000 dwellings

The final analysis shows the placebo of affordable rent starts per 1,000 existing dwellings.  It finds no effect of treatment on the rate of affordable rent starts, providing further support of a treatment effect from the policy change on social rent starts. Figure 11 visualises the lack of effect.  


```{r, include = FALSE}
# AIC 3999.47
sr_df %>% 
  lmer(per_1000_ar ~ treatment + Year + I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ

# AIC 4003.57
sr_df %>% 
  lmer(per_1000_ar ~ (treatment * `1920`) + `1819` + `1718` + `1617` + 
         I(afford_gap_median - 50) +
         (1|`LA code`),
       data = .) %>% 
  summ
```


```{r, results = 'asis'}
ar_mods <- list()

ar_mods[c("2015-16", "2019-20")] <- years_list[c(1,5)] %>% 
  map(~lm(per_1000_ar ~ treatment + I(afford_gap_median - 50),
          data = .))

ar_mods[c("2015-16 sensitivity","2019-20 sensitivity")] <-
  years_list[c(1,5)] %>% 
  map(filter, afford_gap_median > 20 & afford_gap_median < 80) %>% 
  map(~lm(per_1000_ar ~ treatment + I(afford_gap_median - 50),
          data = .))

stargazer(ar_mods[[1]], ar_mods[[2]],
          ar_mods[[3]], ar_mods[[4]],
          type = "html",
          style = "ajps",
          dep.var.labels = 
            "Affordable rent starts per 1000 dwellings",
          title = "Affordable rent RDD results",
          align = T,
          omit.stat=c("LL","ser","f"),
          column.labels = c("2015/16",
                            "2019/20",
                            "2015/16: subsample",
                            "2019/20: subsample"),
          star.cutoffs = c(0.05, 0.005, 0.001),
          report = c("vcs*")
)
          
```



```{r, message = FALSE, warning = FALSE}
bind_rows(
  years_list[[1]],
  years_list[[5]]
) %>% 
  mutate(treatment = ifelse(treatment == 1, 
                            "High pressure",
                            "Not high pressure"),
         treatment = fct_relevel(treatment, "Not high pressure")) %>% 
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = I(afford_gap_median - 50),
             y = per_1000_ar)) +
  geom_point(alpha = 1/2) +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(Year),
             cols = vars(treatment),
             scales = "free_x") +
  theme_bw() +
  labs(x = "Affordability gap (GBP, centred around discontinuity)", 
       y = "Affordable rent starts per 1000 existing dwellings",
       caption = "Figure 11: Treatment effect for rate of affordable rent starts per 1000 existing dwellings.\n2015-16 compared with 2019/20. Excluding London.") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))
```